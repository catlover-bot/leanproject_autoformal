# Autoformal: 非形式的証明の自動形式化パイプライン

このリポジトリは、自然言語＋数式の非形式的証明をLean4形式証明へ自動変換するパイプラインです。

## 構成
- `data/`: アノテーション済みデータと前処理ツール
- `prompts/`: LLMプロンプトテンプレート
- `src/`: パイプライン実装モジュール
- `lean/`: Lean4プロジェクト
- `results/`: 実験ログ・可視化結果

## セットアップ
```bash
git clone <repo_url>
cd autoformal
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
leanproject get-mathlib

## 仮想環境アクティブ
venv\Scripts\activate
```

本研究の新規性は主に以下の４点にまとめられます。

1. **非形式的証明→形式的証明の一貫自動化パイプライン**  
   - 既存研究では「形式証明を自然言語化」あるいは「自然言語コメント付き形式証明→モデル訓練」が中心でしたが、本研究は「教科書や論文に書かれた非形式的（自然言語＋数式）証明」を直接 Lean4 の検証可能コードへ変換する、一気通貫のワークフローを初めて構築します。

2. **Chain‑of‑Thought誘導による細分化→マッピング戦略**  
   - 自然言語証明を「意味のあるサブステップ」に分割する際にも、分割された各ステップを Lean4 の具体的な tactic 呼び出しにマッピングする際にも、いずれも CoT プロンプト設計を用いて LLM の思考過程を明示的に誘導し、精度と可説明性を両立します。

3. **誤り駆動型の反復検証ループ**  
   - 通常の CoT プロンプトのみでは一次生成にエラーが残りがちですが、Lean4 が返す「unknown tactic」「未解決サブゴール」などのエラーメッセージを自動解析し、それをプロンプトに再注入することで、段階的に生成品質を高めるフィードバックループを提案・実装します。これにより、最終的な完全証明取得率（Pass@1）が大幅向上します。

4. **非形式的証明付きベンチマークの再構成と定量評価**  
   - miniF2F や TRIGO‑real といった既存ベンチマークを「非形式的証明テキスト付き」に再構成し、Autoformalization の定量的評価を可能にした点も新機軸です。従来のベンチマークは「形式的命題＋正解コード」のみでしたが、本研究は「非形式命題＋生成コード」という形で評価し、Autoformalization の実用性・汎用性を初めて数値化します。

---

これらを組み合わせることで、単なる「LLM→proof assistant 呼び出し」や「形式化データセット構築」を越えた、自動化・反復改善・定量評価を一体化した研究として、新しい地平を切り拓きます。


---

## 1. ワンクリックで非形式→形式をつなぐ “自動変換ライン”

- **従来：**  
  - 教科書の証明を読んだあと、手作業でLeanのコードを書いていた  
  - あるいは、既にあるLeanコードを日本語に直す研究はあったが、逆方向はバラバラ  

- **本研究：**  
  - 「日本語＋数式の証明テキスト」をそのまま読み込んで  
  - 自動で「ステップに分け → それぞれに対応するLeanのtacticを生成 → Leanで検証」  
  - という流れを１本のプログラム（パイプライン）にまとめました  

これによって、「非形式的証明から形式的証明への敷居」をぐっと下げられます。

---

## 2. 「論理のかたまり」で切り分ける CoT 分割

- **イメージ：** 複雑な文章を「Ａ→Ｂ」「Ｂ→Ｃ」「Ｃ→結論」の三行ノートに書き直す  
- **どうやるか：**  
  1. LLM に「ここを切って３つのステップにまとめて」と頼むと  
  2. 「だから…」「よって…」などのキーワードで、論理が塊になる位置を自動認識して分割  
- **効果：** 人手の境界付けデータと比べても約８割の一致率が出る精度を実現

---

## 3. 「間違えたら直す」をくり返すフィードバックループ

- **普通：** 一度だけコードを生成して終わり → 間違いが残る  
- **本研究：**  
  1. 生成したLeanコードを実際にチェック  
  2. 「unknown tactic」「サブゴールが残った」などエラーメッセージを解析  
  3. その内容をLLMへの次の質問（プロンプト）に組み込んで再実行  
  4. 成功するまで（最大数回）くり返す  
- **効果：** 一回だけで約４割成功だったものが、３回くり返すと６〜７割に伸びる

---

## 4. 「元の日本語付き」でベンチマークを再定義

- **従来ベンチマーク：**  
  - Leanの命題と正解コードだけ  
- **本研究：**  
  - 同じ問題に対して「教科書調の日本語証明テキスト」を用意し、JSON化  
  - 日本語テキスト→自動形式化→正解コード と比較する評価を新設  
- **結果：**  
  - 合計600問超のテストセットで実運用レベルの定量評価が可能に

---

### ──まとめ──  
1. **端から端まで自動化**：日本語証明 → Leanコード  
2. **ステップ分割**：論理のかたまりで切り分け  
3. **くり返し改善**：エラーを見て何度も直す  
4. **新しい評価**：元の日本語テキスト付きで性能を測る  

これらを組み合わせることで、「教科書を書いたそのまま」をLean4で動かせるようにした点、そして従来より大きく精度を上げた点が最大の新規性です。

Lean定理 → GPTで自然語に変換 → サブステップ化 → tacticに変換 → Leanで検証
